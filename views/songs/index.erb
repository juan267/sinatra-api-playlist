<h1>Playlist</h1>


<h1>Add New Song with Ajax</h1>

<form id="song-form-new-ajax" action="/songs/new" method="post" class="song-form">
  <div class="form_field">
    <label for="song_title">Title</label>
    <input type="text" id="song_title" name="song[title]" value="" class="clearable"/>

    <div id="song_title_error" class="validation_error"></div>
  </div>
  <div class="form_field">
    <label for="song_artist">Artist</label>
    <input type="text" id="song_artist" name="song[artist]" value="" class="clearable"/>

    <div id="song_artist_error" class="validation_error"></div>
  </div>
  <div class="form_buttons">
    <input type="submit">
  </div>
</form>

<ul id="playlist-songs">
  <% @songs.each do |song| %>
      <li><a href="/song/<%= song.id %>"><%= song.title %></a> by <%= song.artist %></li>
  <% end %>
</ul>

<script>
    $(document).ready(function () {

        function PlaylistModel() {
            this.songs = [];
            this.callbacks = [];
            this.reload = function () {
                var playlist = this;
                var promise = $.ajax({
                    type: "GET",
                    url: '/api/v1/songs',
                    dataType: 'json'
                });
                promise.done(function (data) {
                    playlist.songs = data;
                    playlist.notifySubscribers();
                });
                promise.fail(function (data) {
                    debugger;
                    console.log(data);
                    console.log(playlist);
                });
            };
            this.notifySubscribers = function () {
                for (var i = 0; i < this.callbacks.length; i++) {
                    this.callbacks[i](this);
                }
            };
            this.subscribe = function (subscriberFunction) {
                this.callbacks.push(subscriberFunction)
            };
        }

        function PlaylistView($container) {
            this.$container = $container;
            this.refresh = function (playlistModel) {
                this.$container.html('');
                for (var i = 0; i < playlistModel.songs.length; i++) {
                    var song = playlistModel.songs[i];
                    var $li = $('<li><a href="/song/' + song['id'] + '">' + song['title'] + '</a> by ' + song['artist'] + '</li>');
                    this.$container.append($li);
                }

            }
        }


        var model = new PlaylistModel();
        var view = new PlaylistView($('#playlist-songs'));

        model.subscribe(function (playlist) {
            view.refresh(playlist)
        });

        $('#song-form-new-ajax').submit(function (event) {
            $form = $(this);
            event.preventDefault();
            var promise = $.ajax({
                type: "POST",
                url: '/api/v1/songs/new',
                dataType: 'json',
                data: $form.serialize() // serializes the form's elements.
            });

            promise.done(function (data) {
                console.log(data); // show response from the php script.
                $form.find('input.clearable').val('');
                $form.find('.validation_error').text('');
                model.reload();
            });
            promise.fail(function (data) {
                var errors = data.responseJSON.errors;
                console.log(errors); // show response from the php script.
                $form.find('.validation_error').text('');
                for (var prop in errors) {
                    if (errors.hasOwnProperty(prop)) {
                        var message = errors[prop][0];
                        $form.find("#song_" + prop + "_error").text(message);
                    }
                }
            });

        });
    });
</script>